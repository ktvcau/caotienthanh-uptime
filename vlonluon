bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  
  if (approvedUsers[chatId] || chatId.toString() === adminChatId) {
    if (msg.text === '/uptime') {
      bot.sendMessage(chatId, 'â— ÄÆ°á»£c rá»“i hÃ£y gá»­i cho tÃ´i 1 liÃªn káº¿t bot cá»§a báº¡n.');
    } else if (msg.text && msg.text.match(/^(http:\/\/|https:\/\/).*\.repl\.co\/?$/)) {
      if (!storage[chatId]) storage[chatId] = [];
      storage[chatId].push(msg.text);
      bot.sendMessage(chatId, `âš¡ Báº¯t Ä‘áº§u theo dÃµi ${msg.text}\n[ Sá»­ dá»¥ng /noti Ä‘á»ƒ báº­t hoáº·c táº¯t thÃ´ng bÃ¡o ]`);
      saveToFile();
    } else if (msg.text.startsWith('/removed ')) {
      const url = msg.text.split(' ')[1];
      if (storage[chatId] && storage[chatId].includes(url)) {
        const index = storage[chatId].indexOf(url);
        storage[chatId].splice(index, 1);
        saveToFile();
        bot.sendMessage(chatId, `ğŸ—‘ï¸ ÄÃ£ loáº¡i bá» liÃªn káº¿t : ${url}`);
      } else {
        bot.sendMessage(chatId, 'â“ LiÃªn káº¿t nÃ y khÃ´ng Ä‘Æ°á»£c tÃ¬m tháº¥y trong danh sÃ¡ch theo dÃµi cá»§a báº¡n.');
      }
    } else if (msg.text === '/noti') {
      notificationPreferences[chatId] = !notificationPreferences[chatId];

      fs.writeFileSync('notificationSettings.json', JSON.stringify(notificationPreferences));

      const notificationStatus = notificationPreferences[chatId] ? 'báº­t\nNáº¿u báº¡n muá»‘n táº¯t thÃ¬ dÃ¹ng lá»‡nh /noti thÃªm 1 láº§n ná»¯a.' : 'táº¯t\nNáº¿u báº¡n muá»‘n báº­t thÃ¬ dÃ¹ng lá»‡nh /noti thÃªm 1 láº§n ná»¯a.';
      bot.sendMessage(chatId, `ğŸ”” ThÃ´ng bÃ¡o cá»§a báº¡n Ä‘ang á»Ÿ tráº¡ng thÃ¡i lÃ  ${notificationStatus}`);
    }
  } else {
    bot.sendMessage(chatId, 'ğŸ” Báº¡n khÃ´ng Ä‘Æ°á»£c phÃ©p sá»­ dá»¥ng bot nÃ y.\nğŸ”ˆNháº¥n nÃºt duyá»‡t sáº½ gá»­i tá»›i Admin Bot vá» quyá»n sá»­ dá»¥ng bot.', {
      reply_markup: {
        inline_keyboard: [
          [
            {
              text: 'Duyá»‡t',
              callback_data: 'request_approval'
            }
          ]
        ]
      }
    });
  }
});

bot.on('callback_query', (query) => {
  const chatId = query.message.chat.id;
  
  if (query.data === 'request_approval') {
    const firstName = query.message.chat.first_name || "";
    const lastName = query.message.chat.last_name || "";  
    const fullName = `${firstName} ${lastName}`.trim();
    bot.sendMessage(chatId, 'âš™ï¸ YÃªu cáº§u cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c gá»­i tá»›i Admin Bot : @ktvcau\nğŸŸ¢ Äá»ƒ Ä‘Æ°á»£c duyá»‡t thÃ¬ hÃ£y liÃªn há»‡ Admin Bot!');
    const userChatId = query.data.split('_')[1];
    bot.sendMessage(adminChatId, `ğŸ—£ï¸ TÃªn cá»§a ngÆ°á»i dÃ¹ng nÃ y : ${fullName}\nğŸ†” : ${chatId} cÃ³ yÃªu cáº§u cáº§n phÃª duyá»‡t Ä‘á»ƒ sá»­ dá»¥ng bot.`, {
      reply_markup: {
        inline_keyboard: [
          [
            {
              text: 'Duyá»‡t',
              callback_data: `approve_${chatId}`
            },
            {
              text: 'Tá»« chá»‘i',
              callback_data: `deny_${chatId}`
            }
          ]
        ]
      }
    });
  } else if (query.data.startsWith('approve_')) {
    const firstName = query.message.chat.first_name || "";
    const lastName = query.message.chat.last_name || "";  
    const fullName = `${firstName} ${lastName}`.trim();
    const userChatId = query.data.split('_')[1];
    approvedUsers[userChatId] = true;
    fs.writeFileSync('approvedUsers.json', JSON.stringify(approvedUsers));
    bot.sendMessage(userChatId, 'âœ… YÃªu cáº§u cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c Admin Bot cháº¥p thuáº­n.\nBÃ¢y giá» báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng bot bÃ¬nh thÆ°á»ng!');
    bot.sendMessage(adminChatId, `âœ… ÄÃ£ cháº¥p thuáº­n yÃªu ngÆ°á»i dÃ¹ng bot\nğŸ—£ï¸ NgÆ°á»i phÃª duyá»‡t | Admin Bot : ${fullName}\nğŸ†” NgÆ°á»i dÃ¹ng Ä‘Æ°á»£c duyá»‡t : ${userChatId}`);                
  } else if (query.data.startsWith('deny_')) {
    const firstName = query.message.chat.first_name || "";
    const lastName = query.message.chat.last_name || "";  
    const fullName = `${firstName} ${lastName}`.trim();
    const userChatId = query.data.split('_')[1];
    fs.writeFileSync('blockedUsers.json', JSON.stringify(approvedUsers));
    bot.sendMessage(userChatId, 'ğŸš« YÃªu cáº§u cá»§a báº¡n Ä‘Ã£ bá»‹ Admin Bot tá»« chá»‘i.\nLÃ­ do : Admin Bot cáº£m tháº¥y báº¡n cÃ³ Ã½ Ä‘á»‹nh xáº¥u vá»›i bot.');
    bot.sendMessage(adminChatId, `ğŸš« ÄÃ£ tá»« chá»‘i yÃªu ngÆ°á»i dÃ¹ng bot\nAdmin Bot : ${fullName}\nğŸ†” NgÆ°á»i dÃ¹ng bá»‹ tá»« chá»‘i : ${userChatId}`); 
  }
});

setInterval(async () => {
  for (const [chatId, urls] of Object.entries(storage)) {
    for (const url of urls) {
      const isUp = await checkURL(url);
      
      if (notificationPreferences[chatId]) {
        bot.sendMessage(chatId, `ğŸŒ Äang theo dÃµi liÃªn káº¿t trÃªn server riÃªng cá»§a bot\nâ±ï¸ Hiá»‡n táº¡i liÃªn káº¿t : ${url} cÃ³ tráº¡ng thÃ¡i ${isUp ? 'á»•n Ä‘á»‹nh' : 'xáº£y ra lá»—i\nHÃ£y kiá»ƒm tra láº¡i liÃªn káº¿t vÃ  bot cá»§a báº¡n.'}`);
      }
    }
  }
}, 3 * 60 * 1000);
